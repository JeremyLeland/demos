<title>Cell Maze Editor</title>
<link rel="stylesheet" href="../style.css">

<body>
  <canvas id="canvas" width="800px" height="800px"></canvas>
</body>

<script type="module">
  import { Cell } from '../src/Cell.js';
  import { CellMap } from '../src/CellMap.js';
  import * as CellGrid from '../src/CellGrid.js';

  import { Curve } from '../src/Curve.js';
  
  const width = 900, height = 900;
  const MIN_EDGE_LENGTH = 40;

  const cellMap = CellMap.fromCellGrid( CellGrid.getHexTriangleGrid( 20, 20, 32, 20 ) );
  cellMap.fullyLink();
    
  const ctx = document.getElementById( 'canvas' ).getContext( '2d' );
  ctx.translate( 32, 32 );

  draw();

  let mouseDown = false;
  document.addEventListener( 'mousedown', ( e ) => {
    mouseDown = true;
    removeUnderMouse( e );
  } );
  document.addEventListener( 'mousemove', ( e ) => {
    if ( mouseDown ) {
      removeUnderMouse( e );
    }
  } );
  document.addEventListener( 'mouseup', ( e ) => mouseDown = false );

  function removeUnderMouse( e ) {
    const cell = cellMap.cells.find( cell => cell.contains( e.clientX - 32, e.clientY - 32 ) );
    if ( cell ) {
      cellMap.removeCell( cell );
      draw();
    }
  }

  function draw() {
    ctx.clearRect( -32, -32, ctx.canvas.width, ctx.canvas.height );

    cellMap.cells.forEach( cell => cell.draw( ctx ) );

    const unvisited = new Set( cellMap.getSolidEdges() );
    const visited = new Set();
    
    while ( unvisited.size > 0 ) {
      const points = [];
      let [ edge ] = unvisited;

      let currentCell = edge.parent;
      let edgeIndex = currentCell.edges.indexOf( edge );

      while ( !visited.has( edge ) ) {
        visited.add( edge );
        unvisited.delete( edge );

        points.push( edge.start );

        edgeIndex = ( edgeIndex + 1 ) % currentCell.edges.length;
        edge = currentCell.edges[ edgeIndex ];

        while ( edge.linked ) {
          edgeIndex = edge.neighbor.edges.findIndex( edge => edge.neighbor == currentCell );
          currentCell = edge.neighbor;
          edgeIndex = ( edgeIndex + 1 ) % currentCell.edges.length;
          edge = currentCell.edges[ edgeIndex ];
        }
      }

      ctx.lineWidth = 1;
      const curves = Curve.getLoopThroughPoints( points );
      curves.forEach( curve => {
        curve.draw( ctx, 0.2 )
      } );
    }
  }


</script>