<title>Avoiding Lines</title>
<link rel="stylesheet" href="../grid.css">

<script type="module">
  import { Canvas } from '../src/common/Canvas.js';
  import { Entity } from '../src/Entity.js';
  import { Line } from '../src/Line.js';
  import { AlienInfo } from '../src/entities/Alien.js';
  
  const entities = [
    new Entity( { x: 17, y: 12, size: 1, angle: 1 }, AlienInfo ),
    new Entity( { x: 17, y: 15, size: 1, angle: 2 }, AlienInfo ),
  ];

  const walls = [
    new Line( 8, 8, 12, 12 ),
    new Line( 12, 12, 15, 18 ),
    new Line( 15, 18, 22, 20 ),
    new Line( 22, 20, 18, 8 ),
    new Line( 18, 8, 8, 8 ),
  ]

  const canvas = new Canvas( document.getElementById( 'canvas' ) );

  let mouseX = 15, mouseY = 15;
  const SIZE = 30;

  const ENTITY_DIST = 1;
  const WALL_DIST = 2;

  canvas.update = ( dt ) => {
    entities.forEach( entity => {
      entity.update( dt, entities );

      entities.forEach( other => {
        if ( entity != other ) {
          const cx = entity.x - other.x;
          const cy = entity.y - other.y;
          const angle = Math.atan2( cy, cx );
          const dist = Math.hypot( cx, cy );

          const force = 0.001 * Math.max( 0, ENTITY_DIST / Math.max( 0.1, dist - entity.size - other.size ) - 1 );

          entity.x += Math.cos( angle ) * force * dt;
          entity.y += Math.sin( angle ) * force * dt;
        }
      } );
      
      walls.forEach( wall => {

        const point = wall.getClosestPoint( entity.x, entity.y );
        const force = 0.001 * Math.max( 0, WALL_DIST / Math.max( 0.1, point.distance - entity.size ) - 1 );

        if ( force > 2 ) {
          debugger;
        }

        entity.x += Math.cos( point.angle ) * force * dt;
        entity.y += Math.sin( point.angle ) * force * dt;

      } );
    } );
  };
  
  canvas.draw = ( ctx ) => {
    ctx.scale( 1 / SIZE, 1 / SIZE );
    ctx.lineWidth = SIZE / canvas.scale;

    entities.forEach( e => e.draw( ctx ) );

    ctx.strokeStyle = 'gray';
    walls.forEach( wall => wall.draw( ctx ) );

    entities.forEach( entity => {

      entities.forEach( other => {
        if ( entity != other ) {
          const cx = entity.x - other.x;
          const cy = entity.y - other.y;
          const angle = Math.atan2( cy, cx );
          const dist = Math.hypot( cx, cy );

          const force = Math.max( 0, ENTITY_DIST / Math.max( 0.1, dist - entity.size - other.size ) - 1 );

          ctx.beginPath();
          ctx.moveTo( other.x, other.y );
          ctx.lineTo( entity.x, entity.y );

          ctx.strokeStyle = `rgb( ${ 255 * force }, 0, 0 )`;
          ctx.stroke();
        }
      } );

      walls.forEach( wall => {

        const point = wall.getClosestPoint( entity.x, entity.y );

        const force = Math.max( 0, WALL_DIST / Math.max( 0.1, point.distance - entity.size ) - 1 )

        ctx.beginPath();
        ctx.moveTo( point.x, point.y );
        ctx.lineTo( entity.x, entity.y );

        ctx.strokeStyle = `rgb( ${ 255 * force }, 0, 0 )`;
        ctx.stroke();
      } )
    } )
  };

  canvas.start();

  let mouseDown = false;

  document.addEventListener( 'pointerdown', ( e ) => doMouse( e ) );
  document.addEventListener( 'pointerup', _ => mouseDown = false );
  document.addEventListener( 'pointermove', ( e ) => {
    if ( mouseDown ) {
      doMouse( e );
    }
  } );

  function doMouse( e ) {
    mouseDown = true;

    mouseX = SIZE * e.offsetX / canvas.scale;
    mouseY = SIZE * e.offsetY / canvas.scale;
    
    entities[ 0 ].x = mouseX;
    entities[ 0 ].y = mouseY;
  }
  
</script>