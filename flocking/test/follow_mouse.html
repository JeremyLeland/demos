<title>Flock around the mouse</title>
<link rel="stylesheet" href="../style.css">

<script type="module">

import { Canvas } from '../src/Canvas.js';
import { ValuesPanel } from '../src/ValuesPanel.js';

const canvas = new Canvas();
canvas.backgroundColor = 'tan';
canvas.zoom = 1 / 20;
canvas.scrollX = -10;
canvas.scrollY = -10;

const entities = [];

for ( let i = 0; i < 20; i ++ ) {
  entities.push( newEntity( 0, i / 10, 'orange' ) );
}


function newEntity( x, y, color ) {
  return {
    x: x,
    y: y,
    dx: 0,
    dy: 0,
    ax: 0,
    ay: 0,
    radius: 0.5 + Math.random() * 0.5,
    fillStyle: color,
  };
}

const target = { x: 0, y: 0 };

canvas.update = ( dt ) => {
  entities.forEach( entity => {
    entity.dx = 0;
    entity.dy = 0;

    const tx = target.x - entity.x;
    const ty = target.y - entity.y;
    const tAngle = Math.atan2( ty, tx );

    // TODO: Make constants for weights, have value panel for constants

    entity.dx = tx * 0.01; //Math.cos( tAngle ) * 0.01;
    entity.dy = ty * 0.01; //Math.sin( tAngle ) * 0.01;

    entities.filter( other => entity != other ).forEach( other => {
      const cx = other.x - entity.x;
      const cy = other.y - entity.y;
      const angle = Math.atan2( cy, cx );
      const dist = Math.hypot( cx, cy ) - entity.radius - other.radius;

      // const val = Math.min( 0, dist ) * 0.01;
      // const val = Math.min( 0, sigma_1( dist ) ) * 0.1;

      const val = Math.exp( -1 * dist ) * 0.01;
      
      
      // if ( dist < entity.radius + other.radius ) {
      //   const val = 0.01 * ( entity.radius + other.radius ) / dist;
        entity.dx -= Math.cos( angle ) * val;
        entity.dy -= Math.sin( angle ) * val;
      // }

    } );

    // entity.dx /= entities.length;
    // entity.dy /= entities.length;

    entity.x += entity.dx * dt;
    entity.y += entity.dy * dt;
  } );
}

function sigma_1( z ) {
  return z / Math.sqrt( 1 + z * z );
}

canvas.draw = ( ctx ) => {
  ctx.lineWidth = 0.002 / canvas.zoom;

  entities.forEach( entity => drawEntity( ctx, entity ) );
}

function drawEntity( ctx, entity ) {
  ctx.beginPath();
  ctx.arc( entity.x, entity.y, entity.radius, 0, Math.PI * 2 );
  ctx.fillStyle = entity.fillStyle;
  ctx.strokeStyle = 'black';
  ctx.fill();
  ctx.stroke();
}

canvas.start();

canvas.pointerDown = ( p ) => {
  canvas.redraw();
}

canvas.pointerMove = ( p ) => {
  target.x = p.x;
  target.y = p.y;
  canvas.redraw();
}

canvas.pointerUp = ( p ) => {
  canvas.redraw();
}

</script>