<title>Draw rocks along walls</title>
<link rel="stylesheet" href="../grid.css">

<script type="module">
  import { Canvas } from './Canvas.js';
  import { Line } from './Line.js';
  import * as Util from './Util.js';

  
  const canvas = new Canvas();

  const SIZE = 100;

  const level = await ( await fetch( './levels/test1.json' ) ).json();
  
  canvas.draw = ( ctx ) => {
    ctx.scale( 1 / SIZE, 1 / SIZE );
    ctx.lineWidth = SIZE / canvas.scale;

    ctx.strokeStyle = 'black';

    level.forEach( loop => {
      for ( let layer = 0; layer < 3; layer ++ ) {
        const points = Util.offsetPoints( loop, -0.3 * layer );

        for ( let i = 0; i < points.length; i ++ ) {
          const curr = points[ i ];
          const next = points[ ( i + 1 ) % points.length ];

          const cx = next[ 0 ] - curr[ 0 ];
          const cy = next[ 1 ] - curr[ 1 ];
          const dist = Math.hypot( cx, cy );
          const angle = Math.atan2( cy, cx );

          const GOAL_LENGTH = 1, LENGTH_VARIANCE = 0.2;
        
          const segments = Math.ceil( dist / GOAL_LENGTH );

          let total = 0;

          const radius = dist / segments / 2;

          // TODO: Redistribute the lengths so some are smaller or larger
          // TODO: Tweak angles to create local in-out variation? (But end up in same place)

          for ( let j = 0; j < segments; j ++ ) {
            const u = ( j + 0.5 ) / segments;
            const x = curr[ 0 ] + u * cx;
            const y = curr[ 1 ] + u * cy;

            ctx.beginPath();
            ctx.ellipse( x, y, radius, 0.3, angle, 0, Math.PI * 2 );

            const shade = 128 - 50 * Math.random();
            ctx.fillStyle = `rgb( ${ shade }, ${ shade }, ${ shade } )`;
            ctx.fill();
            ctx.stroke();

            total += radius * 2;
          }
        }
      }
    } );
  };

  canvas.redraw();

</script>