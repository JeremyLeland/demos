<title>Shrink polygons (removing lines as needed)</title>
<link rel="stylesheet" href="../grid.css">

<script type="module">
  import { Canvas } from './Canvas.js';
  import { Line } from './Line.js';

  
  const canvas = new Canvas();

  const SIZE = 10;

  const loop = [
    [ 2, 2 ],
    [ 6, 1 ],
    [ 7, 5 ],
    [ 6, 8.2 ],
    [ 5, 8 ],
    [ 3, 6 ],
  ];

  canvas.draw = ( ctx ) => {
    ctx.scale( 1 / SIZE, 1 / SIZE );
    ctx.lineWidth = 2 * SIZE / canvas.scale;

    for ( let i = 0; i < loop.length; i ++ ) {
      const prev = loop.at( i - 1 );
      const curr = loop[ i ];
      const next = loop[ ( i + 1 ) % loop.length ];
      const next2 = loop[ ( i + 2 ) % loop.length ];

      ctx.beginPath();
      ctx.moveTo( curr[ 0 ], curr[ 1 ] );
      ctx.lineTo( next[ 0 ], next[ 1 ] );
      
      ctx.strokeStyle = 'green';
      ctx.stroke();

      const normalAngle = Math.atan2( curr[ 0 ] - next[ 0 ], next[ 1 ] - curr[ 1 ] );

      const midX = ( curr[ 0 ] + next[ 0 ] ) / 2;
      const midY = ( curr[ 1 ] + next[ 1 ] ) / 2;

      ctx.beginPath();
      ctx.moveTo( midX, midY );
      ctx.lineTo( midX + Math.cos( normalAngle ) * 0.5, midY + Math.sin( normalAngle ) * 0.5 );

      ctx.stroke();

      const prevNormalAngle = Math.atan2( prev[ 0 ] - curr[ 0 ], curr[ 1 ] - prev[ 1 ] );
      const nextNormalAngle = Math.atan2( next[ 0 ] - next2[ 0 ], next2[ 1 ] - next[ 1 ] );

      for ( let shrink = 0.3; shrink < 1; shrink += 0.3 ) {
        ctx.beginPath();
        ctx.moveTo( curr[ 0 ] - Math.cos( normalAngle ) * shrink, curr[ 1 ] - Math.sin( normalAngle ) * shrink );
        ctx.lineTo( next[ 0 ] - Math.cos( normalAngle ) * shrink, next[ 1 ] - Math.sin( normalAngle ) * shrink );
        
        ctx.strokeStyle = `rgb( ${ 255 - shrink * 100 }, ${ 255 - shrink * 200 }, 0 )`;
        ctx.stroke();
      }

      const uA = moo( 
        prev[ 0 ] + Math.cos( prevNormalAngle ) * -0.3, prev[ 1 ] + Math.sin( prevNormalAngle ) * -0.3, 
        curr[ 0 ] + Math.cos( prevNormalAngle ) * -0.3, curr[ 1 ] + Math.sin( prevNormalAngle ) * -0.3, 
        curr[ 0 ] + Math.cos( normalAngle ) * -0.3, curr[ 1 ] + Math.sin( normalAngle ) * -0.3, 
        next[ 0 ] + Math.cos( normalAngle ) * -0.3, next[ 1 ] + Math.sin( normalAngle ) * -0.3,
      );

      const A = prev[ 0 ] + Math.cos( prevNormalAngle ) * -0.3 + ( curr[ 0 ] - prev[ 0 ] ) * uA;
      const B = prev[ 1 ] + Math.sin( prevNormalAngle ) * -0.3 + ( curr[ 1 ] - prev[ 1 ] ) * uA;

      const uB = moo( 
        curr[ 0 ] + Math.cos( normalAngle ) * -0.3, curr[ 1 ] + Math.sin( normalAngle ) * -0.3, 
        next[ 0 ] + Math.cos( normalAngle ) * -0.3, next[ 1 ] + Math.sin( normalAngle ) * -0.3,
        next[ 0 ] + Math.cos( nextNormalAngle ) * -0.3, next[ 1 ] + Math.sin( nextNormalAngle ) * -0.3, 
        next2[ 0 ] + Math.cos( nextNormalAngle ) * -0.3, next2[ 1 ] + Math.sin( nextNormalAngle ) * -0.3,
      );

      const C = curr[ 0 ] + Math.cos( normalAngle ) * -0.3 + ( next[ 0 ] - curr[ 0 ] ) * uB;
      const D = curr[ 1 ] + Math.sin( normalAngle ) * -0.3 + ( next[ 1 ] - curr[ 1 ] ) * uB;

      ctx.beginPath();
      ctx.moveTo( A, B );
      ctx.lineTo( C, D );
      
      ctx.strokeStyle = 'red';
      ctx.stroke();
    }
  };

  canvas.redraw();

  function fixAngle( a ) {
    return a > Math.PI ? a - Math.PI * 2 : a < -Math.PI ? a + Math.PI * 2 : a;
  }

  function deltaAngle( a, b ) {
    return fixAngle( b - a );
  }

  function moo( x1, y1, x2, y2, x3, y3, x4, y4 ) {
    const D = ( y4 - y3 ) * ( x2 - x1 ) - ( x4 - x3 ) * ( y2 - y1 );

    if ( D != 0 ) {
      const uA = ( ( x4 - x3 ) * ( y1 - y3 ) - ( y4 - y3 ) * ( x1 - x3 ) ) / D;

      return uA;
    }
  }

</script>