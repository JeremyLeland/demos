<title>Shrink polygons (removing lines as needed)</title>
<link rel="stylesheet" href="../grid.css">

<script type="module">
  import { Canvas } from './Canvas.js';
  import { Line } from './Line.js';

  
  const canvas = new Canvas();

  const SIZE = 10;

  const points = [
    [ 2, 2 ],
    [ 6, 1 ],
    [ 9, 6 ],
    [ 6, 8.2 ],
    [ 5.6, 8.2 ],
    [ 5, 8 ],
    [ 3, 6 ],
  ];

  canvas.draw = ( ctx ) => {
    ctx.scale( 1 / SIZE, 1 / SIZE );
    ctx.lineWidth = 2 * SIZE / canvas.scale;

    for ( let scale = 0; scale > -1; scale -= 0.816913147063133 ) {
      ctx.beginPath();
      scalePoly( points, scale ).forEach( p => ctx.lineTo( p[ 0 ], p[ 1 ] ) );
      ctx.closePath();

      ctx.strokeStyle = `rgb( ${ 255 + scale * 100 }, ${ 255 + scale * 200 }, 0 )`;
      ctx.stroke();
    }
  };

  canvas.redraw();

  function scalePoly( points, scale ) {
    const scaled = [];

    for ( let i = 0; i < points.length; i ++ ) {
      const prev = points.at( i - 1 );
      const curr = points[ i ];
      const next = points[ ( i + 1 ) % points.length ];
      const next2 = points[ ( i + 2 ) % points.length ];

      const prevNormalAngle = Math.atan2( prev[ 0 ] - curr[ 0 ], curr[ 1 ] - prev[ 1 ] );
      const normalAngle     = Math.atan2( curr[ 0 ] - next[ 0 ], next[ 1 ] - curr[ 1 ] );
      const nextNormalAngle = Math.atan2( next[ 0 ] - next2[ 0 ], next2[ 1 ] - next[ 1 ] );

      const ang1 = prevNormalAngle + deltaAngle( prevNormalAngle, normalAngle ) / 2;
      const H1 = scale / Math.cos( deltaAngle( ang1, normalAngle ) );

      const ang2 = normalAngle + deltaAngle( normalAngle, nextNormalAngle ) / 2;
      const H2 = scale / Math.cos( deltaAngle( ang2, nextNormalAngle ) );

      const dx1 = Math.cos( ang1 );
      const dy1 = Math.sin( ang1 );
      const dx2 = Math.cos( ang2 );
      const dy2 = Math.sin( ang2 );

      const u = ( dx2 * ( curr[ 1 ] - next[ 1 ] ) - dy2 * ( curr[ 0 ] - next[ 0 ] ) ) / ( dy2 * dx1 - dx2 * dy1 );
      console.log( u * Math.cos( deltaAngle( ang1, normalAngle ) ) );

      scaled.push( [ 
        curr[ 0 ] + Math.cos( ang1 ) * H1,
        curr[ 1 ] + Math.sin( ang1 ) * H1
      ] );
    }

    return scaled;
  }

  function fixAngle( a ) {
    return a > Math.PI ? a - Math.PI * 2 : a < -Math.PI ? a + Math.PI * 2 : a;
  }

  function deltaAngle( a, b ) {
    return fixAngle( b - a );
  }

  function moo( x1, y1, x2, y2, x3, y3, x4, y4 ) {
    const D = ( y4 - y3 ) * ( x2 - x1 ) - ( x4 - x3 ) * ( y2 - y1 );

    if ( D != 0 ) {
      const uA = ( ( x4 - x3 ) * ( y1 - y3 ) - ( y4 - y3 ) * ( x1 - x3 ) ) / D;

      return uA;
    }
  }

</script>