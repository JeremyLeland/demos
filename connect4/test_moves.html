<title>Draw board and pieces</title>
<link rel="stylesheet" href="../grid.css">

<script type="module">
  import { Canvas } from './Canvas.js';
  import { Connect4 } from './Connect4.js';

  const SIZE = 7;
  let scrollX = 0.5, scrollY = 1.5;

  const canvas = new Canvas();

  let game = Connect4.fromLocalStore() ?? Connect4.newGame();

  game.getPossibleMoves();

  game.getLongestAt( 4, 5, 1 );

  canvas.update = ( dt ) => {
    if ( !game.update( dt ) ) {
      canvas.stop();

      game.toLocalStore();
    }
  }
 
  canvas.draw = ( ctx ) => {
    ctx.scale( 1 / SIZE, 1 / SIZE );
    ctx.translate( scrollX, scrollY );
    ctx.lineWidth = 1 / SIZE;

    game.draw( ctx );
  }

  canvas.redraw();

  function updateActivePosition( e ) {
    const mouseX = SIZE * ( e.clientX / canvas.scale ) - scrollX;
    const mouseY = SIZE * ( e.clientY / canvas.scale ) - scrollY;

    game.active.x = Math.max( 0, Math.min( 6, Math.round( mouseX ) ) );
    game.active.y = -1;
  }

  document.addEventListener( 'pointermove', e => {
    if ( game.victory == 0 && game.active.ay == 0 ) {
      updateActivePosition( e );
      
      canvas.redraw();
    }
  } );

  document.addEventListener( 'pointerdown', e => {
    if ( game.victory == 0 ) {
      updateActivePosition( e );

      game.active.ay = 0.00001;
      
      canvas.start();
    }
  } );

  document.addEventListener( 'keydown', e => {
    if ( e.key == 'n' ) {
      game = Connect4.newGame();
    }
    else if ( e.key == 'u' ) {
      game.undo();
    }

    canvas.redraw();
  } );

</script>
