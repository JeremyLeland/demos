<title>Ship Paths</title>
<link rel="stylesheet" href="../grid.css">
<meta charset="utf-8">

<style>
  body {
    width: 100%;
    height: 100%;
  }
  
  #wrapper {
    position: relative;
    aspect-ratio: 1;
    
    min-width: 0%;
    max-width: 100%;
    min-height: 0%;
    max-height: 100%;
    margin: 0 auto;

    display: grid;
    grid-template-rows: auto min-content;
  }

  #playback {
    display: grid;
    grid-template-columns: min-content auto 50px;
  }

  #scrub-wrapper {
    position: relative;
    max-height: 25px;
  }

  #scrubber {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
  }

  canvas {
    width: 100%;
    height: 100%;
  }

  button {
    margin: 0;
    border: 0;
    padding: 0;
    background: none;
  }

</style>

<body>
  <div id="wrapper">
    <canvas id="canvas"></canvas>
    <div id="playback">
      <button id="playpause">▶️</button>
      <div id="scrub-wrapper">
        <canvas id="timeline"></canvas>
        <input id="scrubber" type="range" min="0" max="10000" value="0">
      </div>
      <span id="timestamp">0</span>
    </div>
  </div>
</body>

<script type="module">

  import { Canvas } from '../common/Canvas.js';

  const shipPath = new Path2D();
  shipPath.moveTo( 0.5, 0 );
  shipPath.arc( 0, 0, 0.5, 2.2, -2.2 );
  shipPath.closePath();

  const SIZE = 10;

  const DOWN = Math.PI / 2;

  // TODO: What if we made ship angle always be the direction of travel?
  //       Couldn't do strafing, but they'd look better for curve movement
  //       Would make curve specification more concise
  //       Maybe see what we end up liking to use for levels

  const diag = {
    left: {
      start: { x: 4,   y: -1 },
      c1:    { x: 4,   y: 3.5 },
      c2:    { x: 2.5, y: 3  },
      end:   { x: 1,   y: 11 },
    },
    right: {
      start: { x: 6,   y: -1 },
      c1:    { x: 6,   y: 3.5 },
      c2:    { x: 7.5, y: 3 },
      end:   { x: 9,  y: 11 },
    },
  }
  
  const ships = [
    // 3 slowing waves of scouts
    {
      type: 'Scout',
      time: 1000,
      curve: diag.left,
      duration: 2000,
    },
    {
      type: 'Scout',
      time: 1000,
      curve: diag.right,
      duration: 2000,
    },
    {
      type: 'Scout',
      time: 1500,
      curve: diag.left,
      duration: 3000,
    },
    {
      type: 'Scout',
      time: 1500,
      curve: diag.right,
      duration: 3000,
    },
    {
      type: 'Scout',
      time: 2000,
      curve: diag.left,
      duration: 4000,
    },
    {
      type: 'Scout',
      time: 2000,
      curve: diag.right,
      duration: 4000,
    },

    // Staggered V formation
    {
      type: 'Scout',
      time: 7000,
      curve: {
        start: { x: 1, y: -1 },
        c1: { x: 1, y: -1 },
        c2: { x: 1.5, y: 11 },
        end: { x: 1.5, y: 11 },
      },
      duration: 2000,
    },
    {
      type: 'Scout',
      time: 7000,
      curve: {
        start: { x: 2, y: -1 },
        c1: { x: 2, y: -1 },
        c2: { x: 2.5, y: 11 },
        end: { x: 2.5, y: 11 },
      },
      duration: 1800,
    },
    {
      type: 'Scout',
      time: 7000,
      curve: {
        start: { x: 3, y: -1 },
        c1: { x: 3, y: -1 },
        c2: { x: 3.5, y: 11 },
        end: { x: 3.5, y: 11 },
      },
      duration: 1600,
    },
    {
      type: 'Scout',
      time: 7000,
      curve: {
        start: { x: 4, y: -1 },
        c1: { x: 4, y: -1 },
        c2: { x: 4.5, y: 11 },
        end: { x: 4.5, y: 11 },
      },
      duration: 1400,
    },

    {
      type: 'Scout',
      time: 8000,
      curve: {
        start: { x: 9, y: -1 },
        c1: { x: 9, y: -1 },
        c2: { x: 8.5, y: 11 },
        end: { x: 8.5, y: 11 },
      },
      duration: 2000,
    },
    {
      type: 'Scout',
      time: 8000,
      curve: {
        start: { x: 8, y: -1 },
        c1: { x: 8, y: -1 },
        c2: { x: 7.5, y: 11 },
        end: { x: 7.5, y: 11 },
      },
      duration: 1800,
    },
    {
      type: 'Scout',
      time: 8000,
      curve: {
        start: { x: 7, y: -1 },
        c1: { x: 7, y: -1 },
        c2: { x: 6.5, y: 11 },
        end: { x: 6.5, y: 11 },
      },
      duration: 1600,
    },
    {
      type: 'Scout',
      time: 8000,
      curve: {
        start: { x: 6, y: -1 },
        c1: { x: 6, y: -1 },
        c2: { x: 5.5, y: 11 },
        end: { x: 5.5, y: 11 },
      },
      duration: 1400,
    },
  ];

  const canvas = new Canvas( document.getElementById( 'canvas' ) );

  let worldTime = 0;

  canvas.update = ( dt ) => {
    worldTime += dt;
  }

  canvas.draw = ( ctx ) => {
    ctx.scale( 1 / SIZE, 1 / SIZE );
    ctx.lineWidth = 1 / canvas.scale;

    ctx.fillStyle = 'black';
    ctx.fillRect( 0, 0, SIZE, SIZE );

    ships.forEach( ship => {
      const t = ( worldTime - ship.time ) / ship.duration;

      if ( 0 <= t && t <= 1 ) {   
        const A =     Math.pow( 1 - t, 3 ) * Math.pow( t, 0 );
        const B = 3 * Math.pow( 1 - t, 2 ) * Math.pow( t, 1 );
        const C = 3 * Math.pow( 1 - t, 1 ) * Math.pow( t, 2 );
        const D =     Math.pow( 1 - t, 0 ) * Math.pow( t, 3 );
        
        const c = ship.curve;
        
        const x = A * c.start.x + B * c.c1.x + C * c.c2.x + D * c.end.x;
        const y = A * c.start.y + B * c.c1.y + C * c.c2.y + D * c.end.y;

        const E = 3 * Math.pow( 1 - t, 2 ) * Math.pow( t, 0 );
        const F = 3 * Math.pow( 1 - t, 1 ) * Math.pow( t, 1 );
        const G = 3 * Math.pow( 1 - t, 0 ) * Math.pow( t, 2 );

        const dx = E * ( c.c1.x - c.start.x ) + F * ( c.c2.x - c.c1.x ) + G * ( c.end.x - c.c2.x );
        const dy = E * ( c.c1.y - c.start.y ) + F * ( c.c2.y - c.c1.y ) + G * ( c.end.y - c.c2.y );
        const angle = Math.atan2( dy, dx );
        
        ctx.save();
        ctx.translate( x, y );
        ctx.rotate( angle );
        ctx.fillStyle = 'green';
        ctx.fill( shipPath );
        ctx.restore();

        ctx.beginPath();
        ctx.moveTo( c.start.x, c.start.y );
        ctx.bezierCurveTo( c.c1.x, c.c1.y, c.c2.x, c.c2.y, c.end.x, c.end.y );
        ctx.strokeStyle = 'yellow';
        ctx.stroke();
      }

    } );
  }

  const timeline = new Canvas( document.getElementById( 'timeline' ) );
  timeline.draw = ( ctx ) => {
    ctx.scale( 1 / 10000, 1 );
    ctx.fillStyle = '#ff05';
    ships.forEach( ship => ctx.fillRect( ship.time, 0, ship.duration, 1 ) );
  }

  timeline.redraw();

  const ui = getUI( 'playpause', 'scrubber', 'timestamp' );

  ui.scrubber.addEventListener( 'input', e => setTime( e.target.value ) );

  setTime( 0 );

  function setTime( time ) {
    worldTime = time;

    ui.scrubber.value = time;
    ui.timestamp.innerText = time;
    
    canvas.redraw();
  }

  function getUI( ...ids ) {
    const ui = {};
    ids.forEach( id => ui[ id ] = document.getElementById( id ) );
    return ui;
  }

</script>
