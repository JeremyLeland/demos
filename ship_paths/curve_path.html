<title>Ship Paths</title>
<link rel="stylesheet" href="../grid.css">
<meta charset="utf-8">

<style>
  body {
    width: 100%;
    height: 100%;
  }
  
  #wrapper {
    position: relative;
    aspect-ratio: 1;
    
    min-width: 0%;
    max-width: 100%;
    min-height: 0%;
    max-height: 100%;
    margin: 0 auto;

    display: grid;
    grid-template-rows: auto min-content;
  }

  #playback {
    display: grid;
    grid-template-columns: min-content auto 7vmin;
  }

  canvas {
    width: 100%;
    height: 100%;
  }

  button {
    margin: 0;
    border: 0;
    padding: 0;
    background: none;
  }

</style>

<body>
  <div id="wrapper">
    <canvas id="canvas"></canvas>
    <div id="playback">
      <button id="playpause">▶️</button>
      <input id="scrubber" type="range" min="0" max="10000" value="0">
      <span id="timestamp">0</span>
    </div>
  </div>
</body>

<script type="module">

  import { Canvas } from '../common/Canvas.js';

  const shipPath = new Path2D();
  shipPath.moveTo( 0.5, 0 );
  shipPath.arc( 0, 0, 0.5, 2.2, -2.2 );
  shipPath.closePath();

  const SIZE = 10;

  const DOWN = Math.PI / 2;

  const diag = {
    left: {
      start: { x: 4,   y: -1,   angle: DOWN },
      c1:    { x: 4,   y: 3.5, angle: DOWN + 0.75 },
      c2:    { x: 2.5, y: 3,   angle: DOWN },
      end:   { x: 1,   y: 11,   angle: DOWN },
    },
    right: {
      start: { x: 6,   y: -1,   angle: DOWN },
      c1:    { x: 6,   y: 3.5, angle: DOWN - 0.75 },
      c2:    { x: 7.5, y: 3,   angle: DOWN },
      end:   { x: 9,  y: 11,   angle: DOWN },
    },
  }
  
  const ships = [
    // 3 slowing waves of scouts
    {
      type: 'Scout',
      time: 1000,
      curve: diag.left,
      duration: 2000,
    },
    {
      type: 'Scout',
      time: 1000,
      curve: diag.right,
      duration: 2000,
    },
    {
      type: 'Scout',
      time: 1500,
      curve: diag.left,
      duration: 3000,
    },
    {
      type: 'Scout',
      time: 1500,
      curve: diag.right,
      duration: 3000,
    },
    {
      type: 'Scout',
      time: 2000,
      curve: diag.left,
      duration: 4000,
    },
    {
      type: 'Scout',
      time: 2000,
      curve: diag.right,
      duration: 4000,
    },
  ];

  const canvas = new Canvas( document.getElementById( 'canvas' ) );

  let worldTime = 0;

  canvas.update = ( dt ) => {
    worldTime += dt;
  }

  canvas.draw = ( ctx ) => {
    ctx.scale( 1 / SIZE, 1 / SIZE );

    ctx.fillStyle = 'black';
    ctx.fillRect( 0, 0, SIZE, SIZE );

    ships.forEach( ship => {
      const t = ( worldTime - ship.time ) / ship.duration;

      if ( 0 <= t && t <= 1 ) {   
        const A =     Math.pow( 1 - t, 3 ) * Math.pow( t, 0 );
        const B = 3 * Math.pow( 1 - t, 2 ) * Math.pow( t, 1 );
        const C = 3 * Math.pow( 1 - t, 1 ) * Math.pow( t, 2 );
        const D =     Math.pow( 1 - t, 0 ) * Math.pow( t, 3 );
        
        const c = ship.curve;
        
        const x = A * c.start.x + B * c.c1.x + C * c.c2.x + D * c.end.x;
        const y = A * c.start.y + B * c.c1.y + C * c.c2.y + D * c.end.y;
        const angle = A * c.start.angle + B * c.c1.angle + C * c.c2.angle + D * c.end.angle;
        
        ctx.save();
        ctx.translate( x, y );
        ctx.rotate( angle );
        ctx.fillStyle = 'green';
        ctx.fill( shipPath );
        ctx.restore();
      }
    } );
  }

  const ui = {};
  [ 'playpause', 'scrubber', 'timestamp' ].forEach( e => ui[ e ] = document.getElementById( e ) );

  ui.scrubber.addEventListener( 'input', e => setTime( e.target.value ) );

  setTime( 0 );

  function setTime( time ) {
    worldTime = time;

    ui.scrubber.value = time;
    ui.timestamp.innerText = time;
    
    canvas.redraw();
  }

</script>