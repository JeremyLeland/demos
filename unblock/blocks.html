<link rel='stylesheet' href='../grid.css'>

<style>
  .block {
    position: absolute;
    background-color: red;
  }
</style>

<body></body>

<script>
  document.addEventListener( 'mousedown',  inputStart );
  document.addEventListener( 'touchstart', inputStart );
  document.addEventListener( 'mousemove', inputMove );
  document.addEventListener( 'touchmove', inputMove );
  document.addEventListener( 'mouseup',  inputStop );
  document.addEventListener( 'touchend', inputStop );

  const ARENA_SIZE = 6;
  const BLOCK_SIZE = 32;
  const Direction = { Horizontal: { x: 1, y: 0 }, Vertical: { x: 0, y: 1 } };

  class Block {
    x = 0;
    y = 0;
    width = 0;
    height = 0;
    direction = Direction.Horizontal;
    
    #div;

    constructor( values ) {
      Object.assign( this, values );

      this.#div = document.createElement( 'div' );
      this.#div.className = 'block';
      this.#div.style.width = this.width;
      this.#div.style.height = this.height;
      this.#div.owner = this;
      
      this.updateDiv();

      document.body.appendChild( this.#div );
    }

    get left()    { return this.x; }
    get right()   { return this.x + this.width; }
    get top()     { return this.y; }
    get bottom()  { return this.y + this.height; }

    updateDiv() {
      this.#div.style.transform = `translate( ${ this.x }px,${ this.y }px )`;
    }
  }

  const blocks = [
    new Block( { x: BLOCK_SIZE * 1, y: BLOCK_SIZE * 3, width: BLOCK_SIZE * 2, height: BLOCK_SIZE * 1, direction: Direction.Horizontal } ),
    new Block( { x: BLOCK_SIZE * 5, y: BLOCK_SIZE * 2, width: BLOCK_SIZE * 1, height: BLOCK_SIZE * 2, direction: Direction.Vertical } ),
  ];

  let active, lastX, lastY;
  function inputStart( e ) {
    if ( e.target.owner ) {
      active = e.target.owner;

      const pos = e.touches?.[ 0 ] ?? e;
      lastX = pos.pageX;
      lastY = pos.pageY;
    }
  }

  function inputMove( e ) {
    if ( active ) {
      const pos = e.touches?.[ 0 ] ?? e;
      const dx = pos.pageX - lastX;
      const dy = pos.pageY - lastY;
      lastX = pos.pageX;
      lastY = pos.pageY;

      let minX = 0;
      let minY = 0;
      let maxX = ARENA_SIZE * BLOCK_SIZE - active.width;
      let maxY = ARENA_SIZE * BLOCK_SIZE - active.height;

      blocks.filter( e => e != active ).forEach( other => {
        if ( ( other.top < active.top && active.top < other.bottom ) ||
             ( other.top < active.bottom && active.bottom < other.bottom ) ) {
          const left = other.x + other.width;
          if ( left <= active.x )   minX = Math.max( left, minX );

          const right  = other.x - active.width;
          if ( active.x <= right  ) maxX = Math.min( right,  maxX );
        }

        if ( ( other.left < active.left && active.left < other.right ) ||
             ( other.left < active.right && active.right < other.right ) ) {
          const top  = other.y + other.height;
          if ( top  <= active.y )   minY = Math.max( top,  minY );

          const bottom = other.y - active.height;
          if ( active.y <= bottom ) maxY = Math.min( bottom, maxY );
        }
      } );

      active.x = Math.max( minX, Math.min( maxX, active.x + active.direction.x * dx ) );
      active.y = Math.max( minY, Math.min( maxY, active.y + active.direction.y * dy ) );

      active.updateDiv();
    }
  }

  function inputStop( e ) {
    active = null;
  }

</script>