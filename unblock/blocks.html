<link rel='stylesheet' href='../grid.css'>

<style>
  .block {
    position: absolute;
    border-style: outset;
    border-width: 6;
    border-color: #0006;
    box-sizing: border-box;   /* keep border inside div */
  }
  #victory {
    position: absolute;
    top: 50%;
    width: 100%;
    text-align: center;
    font-family: sans-serif;
    font-size: 50;
    visibility: hidden;
  }
</style>

<body>
  <div id="victory">Victory!</div>
</body>

<script>
  document.addEventListener( 'mousedown',  inputStart );
  document.addEventListener( 'touchstart', inputStart );
  document.addEventListener( 'mousemove', inputMove );
  document.addEventListener( 'touchmove', inputMove );
  document.addEventListener( 'mouseup',  inputStop );
  document.addEventListener( 'touchend', inputStop );

  const ARENA_SIZE = 6;
  const EXIT_ROW = 2;
  const BLOCK_SIZE = 32;
  const Direction = { Horizontal: { x: 1, y: 0 }, Vertical: { x: 0, y: 1 } };

  const BlockType = {
    Primary:     { width: 2 * BLOCK_SIZE, height: 1 * BLOCK_SIZE, direction: Direction.Horizontal, color: 'red'    },
    Horizontal2: { width: 2 * BLOCK_SIZE, height: 1 * BLOCK_SIZE, direction: Direction.Horizontal, color: 'yellow' },
    Horizontal3: { width: 3 * BLOCK_SIZE, height: 1 * BLOCK_SIZE, direction: Direction.Horizontal, color: 'pink'   },
    Vertical2:   { width: 1 * BLOCK_SIZE, height: 2 * BLOCK_SIZE, direction: Direction.Vertical,   color: 'cyan'   },
    Vertical3:   { width: 1 * BLOCK_SIZE, height: 3 * BLOCK_SIZE, direction: Direction.Vertical,   color: 'green'  },
  }

  class Block {
    x = 0;
    y = 0;
    width = 0;
    height = 0;
    direction = Direction.Horizontal;
    color = 'white';
    
    #div;

    constructor( values ) {
      Object.assign( this, values );

      this.#div = document.createElement( 'div' );
      this.#div.className = 'block';
      this.#div.style.width = this.width;
      this.#div.style.height = this.height;
      this.#div.style.backgroundColor = this.color;
      this.#div.owner = this;
      
      this.updateDiv();

      document.body.appendChild( this.#div );
    }

    get left()    { return this.x; }
    get right()   { return this.x + this.width; }
    get top()     { return this.y; }
    get bottom()  { return this.y + this.height; }

    updateDiv() {
      this.#div.style.transform = `translate( ${ this.x }px,${ this.y }px )`;
    }
  }

  const level = [
    { col: 1, row: 2, type: 'Primary' },
    { col: 0, row: 0, type: 'Horizontal2' },
    { col: 2, row: 0, type: 'Vertical2' },
    { col: 5, row: 1, type: 'Vertical3' },
    { col: 2, row: 4, type: 'Horizontal3' },
  ];

  const victoryDiv = document.getElementById( 'victory' );

  const blocks = Array.from( level, e => 
    new Block( Object.assign( { x: e.col * BLOCK_SIZE, y: e.row * BLOCK_SIZE }, BlockType[ e.type ] ) )
  );

  function victory() {
    victoryDiv.style.visibility = 'visible';
  }

  let active, lastX, lastY;
  function inputStart( e ) {
    if ( e.target.owner ) {
      active = e.target.owner;

      const pos = e.touches?.[ 0 ] ?? e;
      lastX = pos.pageX;
      lastY = pos.pageY;
    }
  }

  function inputMove( e ) {
    if ( active ) {
      const pos = e.touches?.[ 0 ] ?? e;
      const dx = pos.pageX - lastX;
      const dy = pos.pageY - lastY;
      lastX = pos.pageX;
      lastY = pos.pageY;

      let minX = 0;
      let minY = 0;
      let maxX = Math.floor( active.y / BLOCK_SIZE ) == EXIT_ROW ? Infinity : ARENA_SIZE * BLOCK_SIZE - active.width;
      let maxY = ARENA_SIZE * BLOCK_SIZE - active.height;

      blocks.filter( e => e != active ).forEach( other => {
        if ( ( other.top < active.top && active.top < other.bottom ) ||
             ( other.top < active.bottom && active.bottom < other.bottom ) ) {
          const left = other.x + other.width;
          if ( left <= active.x )   minX = Math.max( left, minX );

          const right  = other.x - active.width;
          if ( active.x <= right  ) maxX = Math.min( right,  maxX );
        }

        if ( ( other.left < active.left && active.left < other.right ) ||
             ( other.left < active.right && active.right < other.right ) ) {
          const top  = other.y + other.height;
          if ( top  <= active.y )   minY = Math.max( top,  minY );

          const bottom = other.y - active.height;
          if ( active.y <= bottom ) maxY = Math.min( bottom, maxY );
        }
      } );

      active.x = Math.max( minX, Math.min( maxX, active.x + active.direction.x * dx ) );
      active.y = Math.max( minY, Math.min( maxY, active.y + active.direction.y * dy ) );

      active.updateDiv();
    }
  }

  function inputStop( e ) {
    if ( active ) {
      active.x = Math.round( active.x / BLOCK_SIZE ) * BLOCK_SIZE;
      active.y = Math.round( active.y / BLOCK_SIZE ) * BLOCK_SIZE;
      active.updateDiv();
  
      if ( active.x > ARENA_SIZE * BLOCK_SIZE ) {
        victory();
      }
  
      active = null;
    }
  }

</script>